{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description"
              content="เว็บไซต์นี้ให้ข้อมูลเกี่ยวกับ HTML, CSS และการพัฒนาเว็บ">
        <meta name="keywords"
              content="HTML, CSS, JavaScript, เว็บดีไซน์, การพัฒนาเว็บ">
        <title>Welcome Board</title>
        <!-- <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet"> -->
         <link href="{% static 'css/app.css' %}" rel="stylesheet" />
         <link href="{% static 'css/fontawesome/css/fontawesome.min.css' %}" rel="stylesheet" />
         <link href="{% static 'css/fontawesome/css/brands.min.css' %}" rel="stylesheet" />
         <link href="{% static 'css/fontawesome/css/solid.min.css' %}" rel="stylesheet" />
         <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
         <link href="{% static 'css/sweetalert2.min.css' %}" rel="stylesheet">
        <style>
            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden; /* ป้องกัน scroll bar */
            }

            #img {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                /* width: 100vw;
                height: 100vh; */
                object-fit: cover;
                z-index: -1;
            }
            .video {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -1;
            }
        </style>
    </head>
    <body class="">
        <div>
            <!-- <img src="{% static 'images/dragon-bg.jpg' %}" alt="..." /> -->
            <img id="img" class="d-none" alt="..." />
            <video id="video" class="video d-none" autoplay loop muted></video>
        </div>
        
        <!-- <script src="{% static 'js/bootstrap.min.js' %}"></script> -->
        <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
        <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
        <script src="{% static 'js/app.js'%}"></script>
        <script src="{% static 'js/sweetalert2.all.min.js' %}"></script>
        <script src="{% static 'js/custom.js'%}"></script>
        {% if messages %}
            {% for message in messages %}
            <script type="text/javascript">
                $(document).ready(function(){
                    const mssTag = "{{message.tags}}";
                    const mssMsg = "{{message}}";
                    PopMessage(mssMsg, mssTag);
                });
            </script>
            {% endfor %}
        {% endif %}
        <script type="text/javascript">
            $(document).ready(function(){
                const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
                const ws_url = ws_scheme + "://" + window.location.host + "/ws/wb/welcome/";

                let socket = null;
                let reconnectTimer = null;
                let slideshowInterval = null;

                function connectWebSocket(){
                    socket = new WebSocket(ws_url);

                    socket.onopen = function(){
                        console.log("WebSocket connected!");
                        // แจ้ง server ว่าอันนี้ show.html
                        socket.send(JSON.stringify({ action: "filtered" }));
                    };

                    socket.onmessage = function(event){
                        const data = JSON.parse(event.data);
                        if(data.type === "ping"){
                            // ตอบ pong กลับ server
                            socket.send(JSON.stringify({ action: "filtered" }));
                            return;
                        }

                        if(data.type === "send_welcome_board"){
                            updateMedia(data.path, data.media_type);
                        }
                    };

                    socket.onclose = function(){
                        console.log("WebSocket disconnected");
                        clearInterval(slideshowInterval); // clear slideshow
                        slideshowInterval = null;

                        // auto reconnect 3 วินาที
                        if(!reconnectTimer){
                            reconnectTimer = setTimeout(function(){
                                reconnectTimer = null;
                                connectWebSocket();
                            }, 3000);
                        }
                    };

                    socket.onerror = function(err){
                        console.error("WebSocket error", err);
                        socket.close();
                    };
                }

                function updateMedia(paths, mediaType){
                    clearInterval(slideshowInterval);
                    slideshowInterval = null;

                    $("#img").addClass("d-none").removeAttr("src");
                    $("#video").addClass("d-none").removeAttr("src");

                    if(mediaType === "image" && Array.isArray(paths) && paths.length > 0){
                        $("#img").removeClass("d-none");
                        $("#img").attr("src", paths[0].path + "?t=" + new Date().getTime());

                        if(paths.length > 1){
                            let currentIndex = 1;
                            slideshowInterval = setInterval(function(){
                                $("#img").attr("src", paths[currentIndex].path + "?t=" + new Date().getTime());
                                currentIndex = (currentIndex + 1) % paths.length;
                            }, 3000);
                        }
                    } else if(mediaType === "video" && Array.isArray(paths) && paths.length > 0){
                        $("#video").removeClass("d-none");
                        $("#video").attr("src", paths[0].path + "?t=" + new Date().getTime());
                    } else {
                        console.warn("No media data received");
                    }
                }

                connectWebSocket();
            });
        </script>
    </body>
</html>
