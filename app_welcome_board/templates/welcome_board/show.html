{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description"
              content="เว็บไซต์นี้ให้ข้อมูลเกี่ยวกับ HTML, CSS และการพัฒนาเว็บ">
        <meta name="keywords"
              content="HTML, CSS, JavaScript, เว็บดีไซน์, การพัฒนาเว็บ">
        <title>Welcome Board</title>
        <!-- <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet"> -->
         <link href="{% static 'css/app.css' %}" rel="stylesheet" />
         <link href="{% static 'css/fontawesome/css/fontawesome.min.css' %}" rel="stylesheet" />
         <link href="{% static 'css/fontawesome/css/brands.min.css' %}" rel="stylesheet" />
         <link href="{% static 'css/fontawesome/css/solid.min.css' %}" rel="stylesheet" />
         <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
         <link href="{% static 'css/sweetalert2.min.css' %}" rel="stylesheet">
        <style>
            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden; /* ป้องกัน scroll bar */
            }

            #img {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                /* width: 100vw;
                height: 100vh; */
                object-fit: cover;
                z-index: -1;
            }
            .video {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -1;
            }
        </style>
    </head>
    <body class="">
        <div>
            <!-- <img src="{% static 'images/dragon-bg.jpg' %}" alt="..." /> -->
            <img id="img" class="d-none" alt="..." />
            <video id="video" class="video d-none" autoplay loop muted></video>
        </div>
        
        <!-- <script src="{% static 'js/bootstrap.min.js' %}"></script> -->
        <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
        <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
        <script src="{% static 'js/app.js'%}"></script>
        <script src="{% static 'js/sweetalert2.all.min.js' %}"></script>
        <script src="{% static 'js/custom.js'%}"></script>
        {% if messages %}
            {% for message in messages %}
            <script type="text/javascript">
                $(document).ready(function(){
                    const mssTag = "{{message.tags}}";
                    const mssMsg = "{{message}}";
                    PopMessage(mssMsg, mssTag);
                });
            </script>
            {% endfor %}
        {% endif %}
        <script type="text/javascript">
            $(document).ready(function(){
                const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
                const ws_url = ws_scheme + "://" + window.location.host + "/ws/wb/welcome/";

                let socket = null;
                let reconnectTimer = null; // ตัวแปรสำหรับ setTimeout
                let reconnectAttempts = 0; // ตัวนับจำนวนครั้งที่พยายามเชื่อมต่อใหม่
                const maxReconnectAttempts = 10; // จำนวนครั้งสูงสุดที่จะพยายาม
                let slideshowInterval = null;

                function connectWebSocket(){
                    if(socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)){
                        console.log("Socket already open or connecting.");
                        return;
                    }
                    socket = new WebSocket(ws_url);

                    socket.onopen = function(){
                        console.log("WebSocket connected!");
                        reconnectAttempts = 0; // ✅ รีเซ็ตตัวนับเมื่อเชื่อมต่อสำเร็จ
                        if(reconnectTimer) {
                            clearTimeout(reconnectTimer);
                            reconnectTimer = null;
                        }
                        // แจ้ง server ว่าอันนี้ show.html
                        socket.send(JSON.stringify({ action: "filtered" }));
                    };

                    socket.onmessage = function(event){
                        const data = JSON.parse(event.data);
                        console.log("on message :"+data.type);
                        if(data.type === "ping"){
                            // ตอบ pong กลับ server
                            // socket.send(JSON.stringify({ action: "filtered" }));
                            console.log("ตอบ pong กลับ server");
                            socket.send(JSON.stringify({ action: "pong" }));
                            return;
                        }

                        if(data.type === "send_welcome_board"){
                            
                            updateMedia(data.path, data.media_type);
                        }
                    };

                    socket.onclose = function(){
                        console.log("WebSocket disconnected.");
                        clearInterval(slideshowInterval); // clear slideshow
                        slideshowInterval = null;

                        // ✅ พยายามเชื่อมต่อใหม่แบบ Exponential Backoff
                        if (reconnectAttempts < maxReconnectAttempts) {
                            let timeout = Math.pow(2, reconnectAttempts) * 1000; // 1s, 2s, 4s, 8s...
                            console.log(`Attempting to reconnect in ${timeout / 1000} seconds...`);
                            if(reconnectTimer) clearTimeout(reconnectTimer);
                            reconnectTimer = setTimeout(function() {
                                connectWebSocket();
                            }, timeout);
                            reconnectAttempts++;
                        } else {
                            console.error("Max reconnect attempts reached. Giving up.");
                        }
                    };

                }

                function updateMedia(paths, mediaType){
                    console.log("update media : "+mediaType);
                    const videoEl = document.getElementById('video');
                    const imageEl = document.getElementById('img');

                    clearInterval(slideshowInterval);
                    slideshowInterval = null;

                    // --- 1. หยุดและซ่อนวิดีโอก่อนเสมอ ---
                    if (!videoEl.paused) {
                        videoEl.pause();
                    }
                    videoEl.src = ""; // ล้าง source เพื่อให้ browser หยุดโหลด/แสดงผล
                    $(videoEl).addClass("d-none");

                    // --- 2. ซ่อนรูปภาพ ---
                    $(imageEl).addClass("d-none").removeAttr("src");

                    if (mediaType === "image" && Array.isArray(paths) && paths.length > 0) {
                        let currentIndex = 0;
                        const showNextImage = () => {
                            $(imageEl).attr("src", paths[currentIndex].path);
                            console.log("Showing image:", paths[currentIndex].path);
                            currentIndex = (currentIndex + 1) % paths.length;
                        };

                        $(imageEl).removeClass("d-none");
                        showNextImage(); // Show first image immediately

                        if (paths.length > 1) {
                            console.log("path > 1")
                            slideshowInterval = setInterval(showNextImage, 3000);
                        }
                    } else if (mediaType === "video" && Array.isArray(paths) && paths.length > 0) {
                        console.log("new path : "+paths[0].path);
                        // 1. กำหนด source ของวิดีโอใหม่
                        videoEl.src = paths[0].path;
                        // 2. สั่งให้เบราว์เซอร์โหลดวิดีโอใหม่
                        videoEl.load();
                        // 3. สั่งให้เล่นวิดีโอ (หลังจากที่พร้อม)
                        videoEl.play();
                        $(videoEl).removeClass("d-none");
                    } else {
                        console.warn("No media data received");
                    }
                }

                connectWebSocket();
            });
        </script>
    </body>
</html>
