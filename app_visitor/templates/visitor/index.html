{% extends 'layout.html' %}
{% load static %}
{% block title %}<title>Visitor</title>{% endblock %}
{% block breadcrumb %}
<div>
    <span class="fw-bold">Visitor</span>
</div>
{% endblock %}
{% block css %}
<style>
    .fc-daygrid-event {
        white-space: normal !important;
        align-items: normal !important;
    }
    /* กันเหนียว ป้องกัน fc-event-main เป็นสีขาว */
    .fc-event-main {
        background-color: inherit !important;
    }
</style>
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Visitor</h1>
    </div>
</div>
<div class="card">
    <div class="card-body row mb-3">
        <div class="col-12">
            <div id="calendar"></div>
        </div>
    </div>
</div>
<div id="detail" class="card d-none">
    <div class="card-body row mb-3">
        <div class="col-12">
            <div class="row mb-3">
                <div class="col-12">
                    <span id="sdate"></span>
                    <span class="mx-2">-</span>
                    <span id="edate"></span>    
                </div>
            </div>
            <hr>
            <div class="row mb-3">
                <div class="col-sm-12 col-md-6">
                    <p class="fs-6 fst-italic fw-bold text-muted">Room</p>
                    <p id="room" class="fs-2 fw-light"></p>
                </div>
                <div class="col-sm-12 col-md-6">
                    <p class="fs-6 fst-italic fw-bold text-muted">SKT Employee</p>
                    <p id="member" class="fs-2 fw-light"></p>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <p class="fs-6 fst-italic fw-bold text-muted">Guest</p>
                    <p id="gcom" class="fs-2 fw-light pb-0"></p>
                    <p id="gname" class="fs-2 fw-light"></p>
                </div>
            </div>
            <div id="rowEdit" class="row mb-3">
                <div class="col-12">
                    <a href="#" id="edit" class="btn btn-primary btn-lg">
                        <i class="bi bi-pencil-square"></i>
                        <span class="ms-2">Edit</span>
                    </a>
                    <button type="button" id="delete" class="btn btn-secondary btn-lg delete" data-vstid="" onclick="deleteClick(this);">
                        <i class="bi bi-trash"></i>
                        <span class="ms-2">Delete</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
    {% if messages %}
        {% for message in messages %}
        <script type="text/javascript">
            $(document).ready(function(){
                const mssTag = "{{message.tags}}";
                const mssMsg = "{{message}}";
                PopMessage(mssMsg, mssTag);
            });
        </script>
        {% endfor %}
    {% endif %}
    <script type="text/javascript">
        // ---------- Utils ----------
        function getLuminance(r, g, b) {
            const a = [r, g, b].map(function (v) {
                v /= 255;
                return v <= 0.03928
                    ? v / 12.92
                    : Math.pow((v + 0.055) / 1.055, 2.4);
            });
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
        }
        function normalizeHex(hex) {
            hex = (hex || "").replace("#", "").toLowerCase();
            if (hex.length === 3) {
                hex = hex.split("").map(x => x + x).join("");
            } else if (hex.length === 4) {
                hex = hex.split("").map((x, i) => i < 3 ? x + x : "").join("");
            } else if (hex.length === 8) {
                hex = hex.substring(0, 6); // ตัด alpha ทิ้ง
            } else if (hex.length !== 6) {
                hex = "007bff"; // fallback
            }
            return "#" + hex;
        }

        // ---------- Main ----------
        var calendarEl;
        var calendar;
        $(document).ready(()=>{
            ActiveMenu("visitor");
            calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: "prev,next today",
                    center: "title",
                    right: "dayGridMonth,timeGridWeek,timeGridDay,listYear",
                },
                eventDisplay: "block",
                height: "auto",
                aspectRatio: 2,
                eventTimeFormat:{
                    hour12: false,
                    hour: "2-digit",
                    minute: "2-digit",
                },
                events: async function (info, successCallback, failureCallback) {
                    const url = window.location.origin + window.location.pathname+"api/listjs/?sdate="+moment(info.start).format().split("T")[0]+"&edate="+moment(info.end).format().split("T")[0];
                    const apiData = await getAPIData(url);
                    if(Array.isArray(apiData) && apiData.length > 0){
                        const newArr = apiData.map((item)=>{
                            const newItem = {
                                id: item.id,
                                title: item.topic,
                                start: item.sDate,
                                end: item.eDate,
                                color: normalizeHex(item.room.color),
                                room: item.room.name,
                                member: item.sktMember ? item.sktMember : "-",
                                gcom: item.guestCompany,
                                gname: item.guestMember ? item.guestMember : "-",
                                link: window.location.origin + window.location.pathname + "edit/" + item.id,
                                canEdit: canEdit(item),
                            }
                            return newItem
                        });
                        successCallback(newArr);
                    }else{
                        successCallback([]);
                    }
                },
                dateClick: function(info){
                    if(info.dateStr >= new Date().toISOString().split("T")[0]){
                        window.location.href = window.location.origin + window.location.pathname + "add?d=" + info.dateStr;
                    }
                },
                eventClick: function(info){
                    showDetailModal(info);
                },
                eventContent: function(arg) {
                    return { html: '<b class="me-1">(' + arg.event.extendedProps.room + ')</b>' + arg.timeText + ' ' + arg.event.title };
                },
                eventDidMount: function(info) {
                    // apply contrast
                    let bg = normalizeHex(info.event.backgroundColor || info.event.extendedProps.color || "#007bff");
                    let rgb = bg.match(/\w\w/g).map(h => parseInt(h, 16));
                    let luminance = getLuminance(...rgb);
                    let textColor = luminance > 0.5 ? "#000" : "#fff";

                    info.el.style.backgroundColor = bg;
                    info.el.style.color = textColor;

                    let mainEl = info.el.querySelector(".fc-event-main");
                    if (mainEl) {
                        mainEl.style.backgroundColor = bg;
                        mainEl.style.color = textColor;
                    }
                },
                dayCellDidMount: function(info) {
                    if (info.date.getDay() === 0 || info.date.getDay() === 6) {
                        info.el.style.backgroundColor = "#f0f0f0"; // เทาอ่อน
                    }
                }
            });
            calendar.render();
            setInterval(function() {
                calendar.refetchEvents();
            }, 10000);
        });

        const showDetailModal = async (info) => {
            await initialDetailToHTML(info);
            Swal.fire({
                title: `<p class="display-4">${info.event.title}</p>`,
                icon: "info",
                imageWidth: 400,
                imageHeight: 200,
                html: $("#detail").html(),
                showCloseButton: true,
                showCancelButton: false,
                showConfirmButton: false,
                focusConfirm: false,
                width:'40rem',
            });
        }

        const initialDetailToHTML = async (info) =>{
            $("#sdate").text(strUTCDateToStrThaiDate(info.event.start));
            $("#edate").text(strUTCDateToStrThaiDate(info.event.end));
            $("#room").text(info.event.extendedProps.room);
            $("#member").text(info.event.extendedProps.member);
            $('#gcom').text(info.event.extendedProps.gcom);
            $('#gname').text("("+info.event.extendedProps.gname+")");

            if(info.event.extendedProps.canEdit == false){
                $("#rowEdit").addClass("d-none");
                $("#edit").attr("href", "#");
                $("#delete").attr("data-vstid", "");
            }else{
                $("#rowEdit").removeClass("d-none");
                $("#edit").attr("href", info.event.extendedProps.link);
                $("#delete").attr("data-vstid", info.event.id);
            }
        }
        
        const deleteClick = (e) => {
            Loading(true);
            const settings = {
                url: window.location.origin + window.location.pathname + "delete/" + $(e).data('vstid'),
                method: "GET",
            }
            $.ajax(settings).done((response) => {
                calendar.removeEvents($(e).data('vstid'));
                Loading(false);
                if(response.deleted == true){
                    PopMessage("Delete success", "success",true);
                }else{
                    PopMessage(response.message, "error");
                }
            }).fail((xjr, status, error) => {
                Loading(false);
                PopMessage(error, "error");
            });
        }

        const canEdit = (info) => {
            const isSuperAdmin = "{{request.currentUser.isAdmin}}" === "True";
            const createById = info.createBy?.userId ? info.createBy.userId : "";
            const updateById = info.updateBy?.userId ? info.updateBy.userId : "";
            const userId = "{{request.currentUser.id}}";
            const isSettingAdmin = "{{isSettingAdmin}}" === "True";
            if(
                isSuperAdmin == true 
                || isSettingAdmin == true
                || (createById == userId || updateById == userId)
            ){
                return true;
            }
            return false;
        }
    </script>
{% endblock %}
