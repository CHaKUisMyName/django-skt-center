{% extends 'layout.html' %}
{% load static %}
{% block title %}<title>Car Schedule</title>{% endblock %}
{% block breadcrumb %}
<div>
    <span class="fw-bold">Car Schedule</span>
</div>
{% endblock %}
{% block css %}
<style>
    .fc-daygrid-event {
        white-space: normal !important;
        align-items: normal !important;
    }
</style>
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Car Schedule</h1>
    </div>
</div>
{% if request.currentUser %}
<div class="row mb-3">
    <div class="col-12">
        <button id="exportPopup" type="button" class="btn btn-success mb-3">
            <i class="bi bi-file-earmark-excel-fill"></i>
            export
        </button>
    </div>
</div>
{% endif %}
<div class="card">
    <div class="card-body row mb-3">
        <div class="col-12">
            <div id="calendar"></div>
        </div>
    </div>
</div>
<div id="detail" class="card d-none">
    <div class="card-body row mb-3">
        <div class="col-12">
            <div class="row">
                <div class="col-12">
                    <span id="sdate"></span>
                    <span class="mx-2">-</span>
                    <span id="edate"></span>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <p class="fs-6 fst-italic fw-bold text-muted">
                        <i class="bi bi-person me-1"></i>
                        Driver
                    </p>
                    <p id="driver" class="fs-2 fw-light mb-0"></p>
                    <p id="driverPhone" class="fw-light mb-0"></p>
                    <p id="driverLicenseNo" class="fs-5 fw-light text-muted"></p>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <p class="fs-6 fst-italic fw-bold text-muted">
                        <i class="bi bi-journal-bookmark-fill me-1"></i>
                        Purpose
                    </p>
                    <p id="purpose" class="fs-2 fw-light"></p>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <p class="fs-6 fst-italic fw-bold text-muted">
                        <i class="bi bi-geo-alt me-1"></i>
                        Destination
                    </p>
                    <p id="destination" class="fs-2 fw-light"></p>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <p class="fs-6 fst-italic fw-bold text-muted">
                        <i class="bi bi-people me-1"></i>
                        Passengers
                    </p>
                    <div id="passengers"></div>
                </div>
            </div>
            <div id="rowEdit" class="row my-3">
                <div class="col-12">
                    <a href="#" id="edit" class="btn btn-primary btn-lg">
                        <i class="bi bi-pencil-square"></i>
                        <span class="ms-2">Edit</span>
                    </a>
                    <button type="button" id="delete" class="btn btn-secondary btn-lg delete" data-vstid="" onclick="deleteClick(this);">
                        <i class="bi bi-trash"></i>
                        <span class="ms-2">Delete</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% csrf_token %}
<div id="exportDetail" class="card d-none">
    <div class="card-body row mb-3">
        <div class="col-12">
            <div class="row mb-3">
                <div class="col-sm-12 col-lg-6">
                    <label for="sdateExp" class="form-label fw-bold text-dark-emphasis">Start Date</label>
                    <input type="text" id="sdateExp" name="sdateExp" class="form-control">
                </div>
                <div class="col-sm-12 col-lg-6">
                    <label for="edateExp" class="form-label fw-bold text-dark-emphasis">End Date</label>
                    <input type="text" id="edateExp" name="edateExp" class="form-control">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
    {% if messages %}
        {% for message in messages %}
        <script type="text/javascript">
            $(document).ready(function(){
                const mssTag = "{{message.tags}}";
                const mssMsg = "{{message}}";
                PopMessage(mssMsg, mssTag);
            });
        </script>
        {% endfor %}
    {% endif %}
    <script src="{% static 'js/exceljs.js' %}"></script>
    <script type="text/javascript">
        var calendar;
        var calendarEl;
        $(document).ready(function(){
            ActiveMenu("csh");
            calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: "prev,next today",
                    center: "title",
                    right: "dayGridMonth,timeGridWeek,timeGridDay,listYear",
                },
                eventDisplay: "block",
                height: "auto",
                aspectRatio: 2,
                eventTimeFormat:{
                    hour12: false,
                    hour: "2-digit",
                    minute: "2-digit",
                },
                events: async function (info, successCallback, failureCallback) {
                    const url = window.location.origin + window.location.pathname+"api/listjs/?sdate="+moment(info.start).format().split("T")[0]+"&edate="+moment(info.end).format().split("T")[0];
                    const apiData = await getAPIData(url);
                    if(Array.isArray(apiData) && apiData.length > 0){
                        const newArr = apiData.map((item)=>{
                            
                            const newItem = {
                                id: item.id,
                                title: item.title,
                                start: item.sDate,
                                end: item.eDate,
                                color: item.color,
                                driver: item.driver,
                                destination: item.destination,
                                passengers: item.passengers,
                                purpose: item.purpose,
                                link: window.location.origin + window.location.pathname + "edit/" + item.id,
                                canEdit: canEdit(item),
                            }
                            return newItem
                        });
                        successCallback(newArr);
                    }else{
                        successCallback([]);
                    }
                },
                dateClick: function(info){
                    if(info.dateStr >= new Date().toISOString().split("T")[0]){
                        window.location.href = window.location.origin + window.location.pathname + "add?d=" + info.dateStr;
                    }
                },
                dayCellDidMount: function(info) {
                    // à¹€à¸ªà¸²à¸£à¹Œ (6) à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ (0)
                    if (info.date.getDay() === 0 || info.date.getDay() === 6) {
                        info.el.style.backgroundColor = "#f0f0f0"; // à¹€à¸—à¸²à¸­à¹ˆà¸­à¸™
                    }
                },
                eventContent: function(arg){
                    return { html: arg.timeText + ' ' + arg.event.title };
                },
                eventClick: function(info){
                    showDetailModal(info);
                },
            });
            calendar.render();
            // setInterval(function() {
            //     calendar.refetchEvents();
            // }, 10000);
        });
        const showDetailModal = async (info) => {
            await initialDetailToHTML(info);
            Swal.fire({
                title: `<p class="display-6 mb-0">${info.event.title}</p>`,
                // icon: "info",
                // imageWidth: 100,
                // imageHeight: 50,
                html: $("#detail").html(),
                showCloseButton: true,
                showCancelButton: false,
                showConfirmButton: false,
                focusConfirm: false,
                width:'40rem',
            });
        }
        const initialDetailToHTML = async (info) =>{
            clearDetailData();
            $("#sdate").text(strUTCDateToStrThaiDate(info.event.start));
            $("#edate").text(strUTCDateToStrThaiDate(info.event.end));
            const driver = info.event.extendedProps.driver.fNameEN+ " " + info.event.extendedProps.driver.lNameEN;
            $("#driver").text(driver);
            $("#destination").text(info.event.extendedProps.destination ? info.event.extendedProps.destination : "-");
            $("#purpose").text(info.event.extendedProps.purpose ? info.event.extendedProps.purpose : "-");
            
            if (info.event.extendedProps.driver.phone && info.event.extendedProps.driver.phone != "-"){
                $("#driverPhone").text("( "+info.event.extendedProps.driver.phone+" )");
            }
            if (info.event.extendedProps.driver.carLicenseNo){
                $("#driverLicenseNo").text(info.event.extendedProps.driver.carLicenseNo);
            }
            
            if (info.event.extendedProps.passengers && info.event.extendedProps.passengers.length > 0){
                
                const $psdArray = info.event.extendedProps.passengers;
                $.each($psdArray, function(index, value){
                    if(value.id == "0"){
                        const $psgText = $("<p>",{
                            class: "fs-2 fw-light"
                        }).text("-- Other --");
                        $("#passengers").append($psgText);    
                    }else{
                        const $psgText = $("<p>",{
                            class: "fs-2 fw-light"
                        }).text("-- "+value.fNameEN+" "+value.lNameEN+" --");
                        $("#passengers").append($psgText);
                    }
                    
                });
            }else{
                const $psgText = $("<p>",{
                    class: "fs-2 fw-light"
                }).text("-");
                $("#passengers").append($psgText);
            }
            if(info.event.extendedProps.canEdit == false){
                $("#rowEdit").addClass("d-none");
                $("#edit").attr("href", "#");
                $("#delete").attr("data-vstid", "");
            }else{
                $("#rowEdit").removeClass("d-none");
                $("#edit").attr("href", info.event.extendedProps.link);
                $("#delete").attr("data-cshid", info.event.id);
            }
        }
        const clearDetailData = ()=>{
            $("#sdate").text("");
            $("#edate").text("");
            $("#destination").text("");
            $("#driver").text("");
            $("#purpose").text("");
            $("#driverPhone").text("");
            $("#driverLicenseNo").text("");
            $("#passengers").empty();
            $("#edit").attr("href", "#");
            $("#delete").attr("data-cshid", "");
        }
        const deleteClick = (e) => {
            Loading(true);
            
            const settings = {
                url: window.location.origin + window.location.pathname + "delete/" + $(e).data('cshid'),
                method: "GET",
            }
            $.ajax(settings).done((response) => {
                Loading(false);
                if(response.deleted == true){
                    var event = calendar.getEventById($(e).data('cshid'));
                    if(event){
                        event.remove();
                    }
                    PopMessage("Delete success", "success",true);
                }else{
                    PopMessage(response.message, "error");
                }
                // calendar.refetchEvents();
            }).fail((xjr, status, error) => {
                Loading(false);
                PopMessage(error, "error");
                // calendar.refetchEvents();
            });
        }
        const canEdit = (info) => {
            const isSuperAdmin = "{{request.currentUser.isAdmin}}" === "True";
            const createById = info.createBy?.userId ? info.createBy.userId : "";
            const updateById = info.updateBy?.userId ? info.updateBy.userId : "";
            const userId = "{{request.currentUser.id}}";
            const isSettingAdmin = "{{isSettingAdmin}}" === "True";
            
            if(
                isSuperAdmin == true 
                || isSettingAdmin == true
                || (createById == userId || updateById == userId)
            ){
                return true;
            }
            return false;
        }
        var dv = undefined;
        const createExcel = async (data) =>{
            
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("My Sheet", {
            views: [{ state: "frozen", ySplit: 1 }],
            });

            const col = [];
            // const dayAllYear = getDays(new Date());
            const dayAllYear = getDaysByRange(data.sdate, data.edate);

            col.push({
                header: "Date/Time",
                key: "date",
                width: 15,
                alignment: { wrapText: true },
            });
            var rowObj = {};
            rowObj["date"] = "";
            $.each(data.drivers, function(i, v){
                col.push({
                    header: v.user.fNameEN + " " + v.user.lNameEN,
                    key: "dv" + v.id,
                    width: 25,
                });
                rowObj["dv" + v.id] = "";
            });
            worksheet.columns = col;
            $.each(col, function (i, v) {
                worksheet.getColumn(i + 1).alignment = {
                    wrapText: true,
                    vertical: "top",
                };
                worksheet.getColumn(i + 1).border = {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" },
                };
            });
            // -- header style
            worksheet.getRow(1).alignment = {
                horizontal: "center",
                wrapText: true,
                vertical: "top",
                vertical: "middle",
            };
            worksheet.getRow(1).height = 45;
            worksheet.getRow(1).font = { bold: true, size: 16 };

            // -- date column
            worksheet.getColumn(1).alignment = {
                horizontal: "center",
                wrapText: true,
                vertical: "middle",
            };
            $.each(dayAllYear, function(i, d){
                console.log(d);
                let main = jQuery.extend({}, rowObj);
                const all = moment(d.date, "DD-MM-YYYY").format("YYYY-MM-DD");
                const csh = data.schedules.filter(
                    (e) => moment(e.sDate).format("YYYY-MM-DD") == all
                );
                $.each(csh, function(i, v){
                    
                    const start = moment(v.sDate).format("HH:mm");
                    const end = moment(v.eDate).format("HH:mm");
                    let psg = "";
                    psg += v.title + "\r\n";
                    if(
                        v.passengers != undefined &&
                        v.passengers != null &&
                        v.passengers.length > 0
                    ){
                        $.each(v.passengers, function(i, p){
                            if(p.id == "0"){
                                psg += "-- Other --\r\n";
                            }else{
                                psg += p.fNameEN + " " + p.lNameEN + "\r\n";
                            } 
                        });
                        psg += start + " -> " + end;
                    }
                    var drive = main["dv" + v.driver.id];
                    if(drive){
                        main["dv" + v.driver.id] = drive + "\r\n--------------------------\r\n" + psg;
                    }else{
                        main["dv" + v.driver.id] = psg;
                    }
                });
                main["date"] = d.date + "\r\n" + d.day;
                worksheet.addRow(main);
            });
            // Iterate over all rows that have values in a worksheet
            worksheet.eachRow(function (row, rowNumber) {
            if (rowNumber > 1) {
                const day = row.values[1].toString().toLowerCase();
                if (day.includes("sunday") || day.includes("saturday")) {
                row.eachCell(function (cell, colNumber) {
                    cell.fill = {
                    type: "pattern",
                    pattern: "solid",
                    fgColor: { argb: "ccffacac" },
                    };
                });
                }
            }
            });
            // write to a new buffer
            const buffer = await workbook.xlsx.writeBuffer();
            // Convert buffer to a Blob
            const blob = new Blob([buffer], {
                type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            });
            await exportFileFromBlob(blob, "report-carschedlue.xlsx");
            Loading(false);
        }

        const exportFileFromBlob = async (blob, fileName) => {
            // Create a link element
            const link = document.createElement("a");

            // Create an object URL for the blob
            const url = URL.createObjectURL(blob);

            // Set the download attribute with a filename
            link.href = url;
            link.download = fileName;

            // Append the link to the body (it's necessary for Firefox)
            document.body.appendChild(link);

            // Programmatically click the link to trigger the download
            link.click();

            // Clean up and remove the link
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        function getDaysByRange(startDate, endDate) {
            const result = [];
            const weekday = [
                "Sunday",
                "Monday",
                "Tuesday",
                "Wednesday",
                "Thursday",
                "Friday",
                "Saturday",
            ];

            let current = moment(startDate, "DD/MM/YYYY");
            const end = moment(endDate, "DD/MM/YYYY");

            while (current.isSameOrBefore(end, "day")) {
                result.push({
                    date: current.format("DD-MM-YYYY"),
                    day: weekday[current.day()],
                });
                current.add(1, "day");
            }

            return result;
        }


        function getDays(date) {
            var result = [];
            const weekday = [
            "Sunday",
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
            ];

            for (var i = 0; i < 12; i++) {
            var r = date.getDaysInMonth(i);

            $.each(r, function (k, v) {
                var formatted = {
                date: v.getDate() + "-" + (v.getMonth() + 1) + "-" + v.getFullYear(),
                day: weekday[v.getDay()],
                };
                result.push(formatted);
            });
            }

            return result;
        }
        Date.prototype.getDaysInMonth = function (month) {
            var date = new Date(this.getFullYear(), month, 1);
            var days = [];
            while (date.getMonth() === month) {
            days.push(new Date(date));
            date.setDate(date.getDate() + 1);
            }
            return days;
        };
        $('#exportPopup').click(function(e){
            e.preventDefault();
            Swal.fire({
                title: `<p class="display-6">Exprot Car Schedule</p>`,
                html: $("#exportDetail").html(),
                showCloseButton: true,
                showCancelButton: false,
                showConfirmButton: true,
                confirmButtonText: 'Export',   // ðŸ”¹ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸›à¸¸à¹ˆà¸¡
                customClass: {
                    confirmButton: 'btn btn-primary me-2', // ðŸ”¹ à¹ƒà¸Šà¹‰ class bootstrap
                    cancelButton: 'btn btn-secondary'
                },
                buttonsStyling: false, // ðŸ”¹ à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰ SweetAlert à¹„à¸¡à¹ˆ override Bootstrap
                focusConfirm: false,
                width:'40rem',
                didOpen: () => {
                    const sDateEl = document.querySelector('.swal2-container #sdateExp');
                    const eDateEl = document.querySelector('.swal2-container #edateExp');
                    initialDatePk(sDateEl);
                    initialDatePk(eDateEl);
                },
                preConfirm: () => {
                    let valid = true;
                    const sdateExpEl = $(".swal2-container #sdateExp");
                    const edateExpEl = $(".swal2-container #edateExp");
                    
                    if(sdateExpEl.val() == ""){
                        
                        valid = false;
                    }
                    if(edateExpEl.val() == ""){
                        
                        valid = false;
                    }
                    if(sdateExpEl.val() > edateExpEl.val()){
                        
                        valid = false;
                    }
                    if (!valid){ return false };
                    return {
                        sdate: sdateExpEl.val(),
                        edate: edateExpEl.val(),
                    };
                },
            }).then(async (result) => {
                if(result.isConfirmed){
                    Loading(true);
                    const data = result.value;
                    const url = window.location.origin + window.location.pathname + "api/export/";
                    $.ajax({
                        url: url,
                        type: "POST",
                        data: JSON.stringify(data),
                        contentType: "application/json",
                        headers: { "X-CSRFToken": getCSRFToken() },
                    }).done(async function (res) {
                        if(res.success == true){
                            await createExcel(res.data);
                        }else{
                            PopMessage(res.message, "error");
                        }
                        Loading(false);

                    }).fail((xjr, status, error) => {
                        Loading(false);
                        PopMessage(error, "error");
                    });
                        
                }
            });
        });
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
    </script>
{% endblock %}